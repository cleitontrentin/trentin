<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
<meta charset="UTF-8" />
<title>PDV - Venda</title>
</head>
<body>
	<section class="layout-content" layout:fragment="corpo">

		<!-- Barra superior -->
		<nav class="navbar navbar-expand-md bg-light">
			<div class="collapse navbar-collapse" id="navbarsExampleDefault">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item active"><i class="oi oi-cart"></i> <span>Ponto
							de Venda (PDV)</span></li>
				</ul>
			</div>
			<a class="btn btn-primary btn-md" href="/vendas/pdv" role="button">
				<span class="oi oi-loop-circular"></span> <span>Nova Venda</span>
			</a>
		</nav>

		<div class="container mt-4" id="pdv-container">

			<div th:replace="fragments/alert"></div>

			<!-- Cabeçalho da Venda -->
			<div class="card mb-3">
				<div class="card-header bg-primary text-white">
					<strong>Venda Nº </strong><span th:text="${venda.id}">0</span>
				</div>

				<div class="card-body">
					<form th:action="@{'/vendas/' + ${venda.id} + '/finalizar'}"
						th:object="${venda}" method="post" id="formVenda">

						<div class="form-row align-items-end">
							<div class="form-group col-md-4">
								<label for="codigo">Código do Produto</label> <input type="text"
									id="codigo" name="codigo" class="form-control"
									placeholder="Digite ou escaneie o código do produto">
							</div>

							<div class="form-group col-md-2">
								<label for="quantidade">Qtd</label> <input type="number"
									id="quantidade" class="form-control" min="1" value="1">
							</div>

							<div class="form-group col-md-2">
								<button type="button" class="btn btn-success btn-block mt-4"
									id="btnAdicionar">
									<i class="oi oi-plus"></i> Adicionar
								</button>
							</div>

							<div class="form-group col-md-4">
								<label for="metodoPagamento">Método de Pagamento</label> <select
									class="form-control" name="metodoPagamento"
									id="metodoPagamento">
									<option value="DINHEIRO">Dinheiro</option>
									<option value="CARTAO_CREDITO">Crédito</option>
									<option value="CARTAO_DEBITO">Débito</option>
									<option value="PIX">Pix</option>
								</select>
							</div>
						</div>

						<div class="form-group mt-3">
							<label for="cliente">Cliente (opcional)</label> <input
								type="text" name="cliente" id="cliente" class="form-control"
								placeholder="Nome do cliente">
						</div>

						<button type="submit" class="btn btn-primary btn-sm">Finalizar
							Venda</button>
					</form>
				</div>
			</div>

			<!-- Tabela de Itens -->
			<div class="card">
				<div class="card-header">
					<strong>Itens da Venda</strong>
				</div>

				<div class="card-body">
					<table class="table table-striped table-sm">
						<thead>
							<tr>
								<th>#</th>
								<th>Produto</th>
								<th>Quantidade</th>
								<th>Preço Unitário</th>
								<th>Total</th>
							</tr>
						</thead>

						<tbody id="tabelaItens">
							<tr th:each="item, iter : ${venda.itens}">
								<td th:text="${iter.index + 1}">1</td>
								<td th:text="${item.produto.name}">Produto</td>
								<td th:text="${item.quantidade}">1</td>
								<td
									th:text="${#numbers.formatDecimal(item.precoUnitario, 1, 2)}">0.00</td>
								<td th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)}">0.00</td>
							</tr>

							<tr th:if="${#lists.isEmpty(venda.itens)}">
								<td colspan="5" class="text-center">Nenhum item adicionado</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="card-footer text-right">
					<strong>Total: R$ <span
						th:text="${#numbers.formatDecimal(venda.total, 1, 2)}">0.00</span>
					</strong>
				</div>
			</div>
		</div>

	</section>
	<section layout:fragment="scripts">
		<!-- Script AJAX corrigido -->
		<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener("DOMContentLoaded", function () {
    console.log("Script carregado");

    const btnAdicionar = document.getElementById("btnAdicionar");
    const codigoInput = document.getElementById("codigo");
    const quantidadeInput = document.getElementById("quantidade");
    const vendaId = /*[[${venda.id}]]*/ 0;
    console.log("Venda ID:", vendaId);

    btnAdicionar.addEventListener("click", function () {
        const codigo = codigoInput.value.trim();
        const quantidade = quantidadeInput.value;

        if (!codigo) {
            alert("Informe o código do produto.");
            return;
        }

        fetch(`/vendas/${vendaId}/itens`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                codigo: codigo,
                quantidade: quantidade
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.json();
        })
        .then(data => {
            console.log("Item adicionado com sucesso:", data);

            const tabela = document.getElementById('tabelaItens');
            const itens = data.itens;

            // Remove linha "Nenhum item adicionado" se existir
            const semItens = tabela.querySelector('tr td[colspan="5"]');
            if (semItens) {
                tabela.removeChild(semItens.parentElement);
            }

            // Último item adicionado
            const item = itens[itens.length - 1];

            // Cria nova linha
            const novaLinha = document.createElement('tr');
            novaLinha.innerHTML = `
                <td>${itens.length}</td>
                <td>${item.produto.name}</td>
                <td>${item.quantidade}</td>
                <td>${item.precoUnitario.toFixed(2)}</td>
                <td>${item.subtotal.toFixed(2)}</td>
            `;
            tabela.appendChild(novaLinha);

            // Atualiza total no rodapé
            const totalSpan = document.querySelector('.card-footer strong span');
            if (totalSpan) {
                totalSpan.textContent = data.total.toFixed(2);
            }

            // Limpa os campos para nova entrada
            codigoInput.value = '';
            quantidadeInput.value = '1';
        })
        .catch(err => {
            console.error("Erro ao adicionar item:", err);
            alert("Erro ao adicionar item: " + err.message);
        });
    });
});
/*]]>*/
</script>
	</section>
</body>
</html>
